name: Code Formatting Check

on:
  pull_request:
    branches:
      - main
      - master
      - vineet
  push:
    branches:
      - main
      - master
      - vineet

jobs:
  prettier:
    name: Prettier Check (JavaScript/TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    
    strategy:
      matrix:
        project:
          - path: frontend/supplier-portal
            name: Supplier Portal
          - path: frontend/admin-dashboard
            name: Admin Dashboard
          - path: frontend/shopkeeper-mobile
            name: Shopkeeper Mobile
          - path: backend/whatsapp-bot
            name: WhatsApp Bot
          - path: backend/blockchain
            name: Blockchain
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project.path }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ matrix.project.path }}
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          elif [ -f "package.json" ]; then
            npm install
          else
            echo "No package.json found, skipping"
            exit 0
          fi
      
      - name: Check Prettier formatting
        working-directory: ${{ matrix.project.path }}
        run: |
          # Check if Prettier is available (installed or can be run via npx)
          if ! npx prettier --version >/dev/null 2>&1; then
            echo "Prettier not found. Note: Prettier should be added to package.json devDependencies for consistent formatting"
            echo "Skipping Prettier check for ${{ matrix.project.name }}"
            exit 0
          fi
          
          echo "Prettier is available, running format check"
          
          # Determine ignore file path
          IGNORE_PATH=""
          if [ -f ".prettierignore" ]; then
            IGNORE_PATH="--ignore-path .prettierignore"
            echo "Using .prettierignore"
          elif [ -f "../../.gitignore" ]; then
            IGNORE_PATH="--ignore-path ../../.gitignore"
            echo "Using root .gitignore patterns for Prettier"
          fi
          
          # Run Prettier check (read-only, no file modifications)
          if [ -n "$IGNORE_PATH" ]; then
            npx prettier --check $IGNORE_PATH "**/*.{js,jsx,ts,tsx,json,css,scss,md}" || exit 1
          else
            echo "No ignore file found, checking all matching files"
            npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,scss,md}" || exit 1
          fi
        continue-on-error: false

  black:
    name: Black Check (Python)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/blockchain/requirements.txt
      
      - name: Install Black
        run: |
          python -m pip install --upgrade pip
          pip install black
      
      - name: Check Black formatting on backend
        working-directory: backend
        run: |
          black --check --line-length 120 \
            --exclude '/(venv|__pycache__|node_modules|\.venv|env|ENV|\.git|migrations|artifacts|cache)/' \
            . || exit 1
      
      - name: Check Black formatting on blockchain module
        working-directory: backend/blockchain
        run: |
          if find . -name "*.py" -type f | grep -q .; then
            black --check --line-length 120 \
              --exclude '/(venv|__pycache__|node_modules|\.venv|env|ENV|\.git|artifacts|cache|typechain-types)/' \
              . || exit 1
          else
            echo "No Python files found in blockchain module"
          fi
        continue-on-error: false

